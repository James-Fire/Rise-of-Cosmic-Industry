roci_trade_set_inital_variables = {
	set_variable = { which = kiyo_trade_minerals value = 0 }
	set_variable = { which = kiyo_trade_energy value = 0 }
	set_variable = { which = kiyo_trade_food value = 0 }
	set_variable = { which = kiyo_trade_unity value = 0 }
	set_variable = { which = kiyo_trade_consumer_goods value = 0 }
	set_variable = { which = kiyo_trade_alloys value = 0 }
	set_variable = { which = kiyo_trade_physics_research value = 0 }
	set_variable = { which = kiyo_trade_society_research value = 0 }
	set_variable = { which = kiyo_trade_engineering_research value = 0 }
	set_variable = { which = kiyo_trade_trade_value value = 0 }
}

pay_trade_cargo_expansion = {
	if = {
		limit = {
			country_uses_consumer_goods = yes
		}
		add_resource = {
			energy = -750
		}
		add_resource = {
			consumer_goods = -750
		}
	}
	else = {
		add_resource = {
			energy = -1000
		}
		add_resource = {
			minerals = -1000
		}
	}
}

#Make sure the fleet has the correct upkeep modifier
#THIS = FLEET
kiyo_correct_fleet_upkeep = {
	remove_modifier = kiyo_trade_cargo_fleet_2
	add_modifier = {
		modifier = kiyo_trade_cargo_fleet_2 days = -1
		mult = kiyo_trade_max_cargo_ships_per_fleet
	}
}

# Calculates resources to all trade ships in trade fleet by resource production
# THIS = FLEET
kiyo_trade_calculate_resources = {
	#Add intel and opinion modifiers to both parties. Opinion does not stack, intel does.
	fleet_event = { id = kiyo_trade_manual_event.51 }
	
	#Ensure the fleet has the correct upkeep
	kiyo_correct_fleet_upkeep = yes
	
	#When the fleet arrives at a planet, we first zero out the existing variables, 
	orbit = {
		set_variable = { which = kiyo_trade_minerals value = 0 }
		set_variable = { which = kiyo_trade_energy value = 0 }
		set_variable = { which = kiyo_trade_food value = 0 }
		set_variable = { which = kiyo_trade_unity value = 0 }
		set_variable = { which = kiyo_trade_consumer_goods value = 0 }
		set_variable = { which = kiyo_trade_alloys value = 0 }
		set_variable = { which = kiyo_trade_physics_research value = 0 }
		set_variable = { which = kiyo_trade_society_research value = 0 }
		set_variable = { which = kiyo_trade_engineering_research value = 0 }
		set_variable = { which = kiyo_trade_trade_value value = 0 }
	}
	#then export planet production
	orbit = {
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = energy
				type = produces
			}
			variable = kiyo_production_energy
			rounded = yes
		}
		
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = minerals
				type = produces
			}
			variable = kiyo_production_minerals
			rounded = yes
		}
		
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = food
				type = produces
			}
			variable = kiyo_production_food
			rounded = yes
		}
		
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = alloys
				type = produces
			}
			variable = kiyo_production_alloys
			rounded = yes
		}
		
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = consumer_goods
				type = produces
			}
			variable = kiyo_production_consumer_goods
			rounded = yes
		}
		
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = physics_research
				type = produces
			}
			variable = kiyo_production_physics_research
			rounded = yes
		}
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = society_research
				type = produces
			}
			variable = kiyo_production_society_research
			rounded = yes
		}
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = engineering_research
				type = produces
			}
			variable = kiyo_production_engineering_research
			rounded = yes
		}
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = unity
				type = produces
			}
			variable = kiyo_production_unity
			rounded = yes
		}
		export_trigger_value_to_variable = {
			trigger = planet_resource_compare
			parameters = {
				resource = trade
				type = produces
			}
			variable = kiyo_production_trade_value
			rounded = yes
		}
	}
	
	#then unload its cargo, and attribute it according to who owns the fleet
	if = {
		limit = {
			owner = {
				is_same_value = prev.orbit.owner
			}
		}
		#And then back to cargo calculation
		
		set_variable = { which = kiyo_trade_minerals_start value = kiyo_trade_minerals }
		set_variable = { which = kiyo_trade_energy_start value = kiyo_trade_energy }
		set_variable = { which = kiyo_trade_food_start value = kiyo_trade_food }
		set_variable = { which = kiyo_trade_unity_start value = kiyo_trade_unity }
		set_variable = { which = kiyo_trade_consumer_goods_start value = kiyo_trade_consumer_goods }
		set_variable = { which = kiyo_trade_alloys_start value = kiyo_trade_alloys }
		set_variable = { which = kiyo_trade_physics_research_start value = kiyo_trade_physics_research }
		set_variable = { which = kiyo_trade_society_research_start value = kiyo_trade_society_research }
		set_variable = { which = kiyo_trade_engineering_research_start value = kiyo_trade_engineering_research }
		set_variable = { which = kiyo_trade_trade_value_start value = kiyo_trade_trade_value }
		orbit = {
			#Set the variables so that these trade resources are attributed to owner trade routes
			set_variable = { which = kiyo_trade_minerals_start value = prev.kiyo_trade_minerals }
			set_variable = { which = kiyo_trade_energy_start value = prev.kiyo_trade_energy }
			set_variable = { which = kiyo_trade_food_start value = prev.kiyo_trade_food }
			set_variable = { which = kiyo_trade_unity_start value = prev.kiyo_trade_unity }
			set_variable = { which = kiyo_trade_consumer_goods_start value = prev.kiyo_trade_consumer_goods }
			set_variable = { which = kiyo_trade_alloys_start value = prev.kiyo_trade_alloys }
			set_variable = { which = kiyo_trade_physics_research_start value = prev.kiyo_trade_physics_research }
			set_variable = { which = kiyo_trade_society_research_start value = prev.kiyo_trade_society_research }
			set_variable = { which = kiyo_trade_engineering_research_start value = prev.kiyo_trade_engineering_research }
			set_variable = { which = kiyo_trade_trade_value_start value = prev.kiyo_trade_trade_value }
		}
	}
	else_if = {
		limit = {
			owner = {
				NOT = { is_same_value = prev.orbit.owner }
			}
		}
		set_variable = { which = kiyo_trade_minerals_end value = kiyo_trade_minerals }
		set_variable = { which = kiyo_trade_energy_end value = kiyo_trade_energy }
		set_variable = { which = kiyo_trade_food_end value = kiyo_trade_food }
		set_variable = { which = kiyo_trade_unity_end value = kiyo_trade_unity }
		set_variable = { which = kiyo_trade_consumer_goods_end value = kiyo_trade_consumer_goods }
		set_variable = { which = kiyo_trade_alloys_end value = kiyo_trade_alloys }
		set_variable = { which = kiyo_trade_physics_research_end value = kiyo_trade_physics_research }
		set_variable = { which = kiyo_trade_society_research_end value = kiyo_trade_society_research }
		set_variable = { which = kiyo_trade_engineering_research_end value = kiyo_trade_engineering_research }
		set_variable = { which = kiyo_trade_trade_value_end value = kiyo_trade_trade_value }
		orbit = {
			#Set the variables so that these trade resources are attributed to non-owner trade routes
			set_variable = { which = kiyo_trade_minerals_end value = prev.kiyo_trade_minerals }
			set_variable = { which = kiyo_trade_energy_end value = prev.kiyo_trade_energy }
			set_variable = { which = kiyo_trade_food_end value = prev.kiyo_trade_food }
			set_variable = { which = kiyo_trade_unity_end value = prev.kiyo_trade_unity }
			set_variable = { which = kiyo_trade_consumer_goods_end value = prev.kiyo_trade_consumer_goods }
			set_variable = { which = kiyo_trade_alloys_end value = prev.kiyo_trade_alloys }
			set_variable = { which = kiyo_trade_physics_research_end value = prev.kiyo_trade_physics_research }
			set_variable = { which = kiyo_trade_society_research_end value = prev.kiyo_trade_society_research }
			set_variable = { which = kiyo_trade_engineering_research_end value = prev.kiyo_trade_engineering_research }
			set_variable = { which = kiyo_trade_trade_value_end value = prev.kiyo_trade_trade_value }
		}
	}
	
	orbit = {
		#Sets the variables that are actually used by the deposit to determine trade production
		set_variable = { which = kiyo_trade_minerals value = prev.kiyo_trade_minerals }
		set_variable = { which = kiyo_trade_energy value = prev.kiyo_trade_energy }
		set_variable = { which = kiyo_trade_food value = prev.kiyo_trade_food }
		set_variable = { which = kiyo_trade_unity value = prev.kiyo_trade_unity }
		set_variable = { which = kiyo_trade_consumer_goods value = prev.kiyo_trade_consumer_goods }
		set_variable = { which = kiyo_trade_alloys value = prev.kiyo_trade_alloys }
		set_variable = { which = kiyo_trade_physics_research value = prev.kiyo_trade_physics_research }
		set_variable = { which = kiyo_trade_society_research value = prev.kiyo_trade_society_research }
		set_variable = { which = kiyo_trade_engineering_research value = prev.kiyo_trade_engineering_research }
		set_variable = { which = kiyo_trade_trade_value value = prev.kiyo_trade_trade_value }
	}
	
	#Load up the cargo fleet with cargo based on planet production
	set_variable = { which = kiyo_trade_minerals value = orbit.kiyo_production_minerals }
	set_variable = { which = kiyo_trade_energy value = orbit.kiyo_production_energy }
	set_variable = { which = kiyo_trade_food value = orbit.kiyo_production_food }
	set_variable = { which = kiyo_trade_unity value = orbit.kiyo_production_unity }
	set_variable = { which = kiyo_trade_consumer_goods value = orbit.kiyo_production_consumer_goods }
	set_variable = { which = kiyo_trade_alloys value = orbit.kiyo_production_alloys }
	set_variable = { which = kiyo_trade_physics_research value = orbit.kiyo_production_physics_research }
	set_variable = { which = kiyo_trade_society_research value = orbit.kiyo_production_society_research }
	set_variable = { which = kiyo_trade_engineering_research value = orbit.kiyo_production_engineering_research }
	set_variable = { which = kiyo_trade_trade_value value = orbit.kiyo_production_trade_value }
	
	##Apply any relevant multipliers to cargo capacity
	
	#Multiply based on number of cargo ships in the fleet
	multiply_variable = { which = kiyo_trade_minerals value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_energy value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_food value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_unity value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_consumer_goods value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_alloys value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_physics_research value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_society_research value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_engineering_research value = kiyo_trade_max_cargo_ships_per_fleet }
	multiply_variable = { which = kiyo_trade_trade_value value = kiyo_trade_max_cargo_ships_per_fleet }
	
	
	# 3/4 Cargo if getting cargo from origin to destination
	if = {
		limit = {
			owner = {
				is_same_value = prev.orbit.owner
			}
		}
		multiply_variable = { which = kiyo_trade_minerals value = 0.75 }
		multiply_variable = { which = kiyo_trade_energy value = 0.75 }
		multiply_variable = { which = kiyo_trade_food value = 0.75 }
		multiply_variable = { which = kiyo_trade_unity value = 0.75 }
		multiply_variable = { which = kiyo_trade_consumer_goods value = 0.75 }
		multiply_variable = { which = kiyo_trade_alloys value = 0.75 }
		multiply_variable = { which = kiyo_trade_physics_research value = 0.75 }
		multiply_variable = { which = kiyo_trade_society_research value = 0.75 }
		multiply_variable = { which = kiyo_trade_engineering_research value = 0.75 }
		multiply_variable = { which = kiyo_trade_trade_value value = 0.75 }
	}
	
	# 1.5x Cargo if fleet owner is corporate authority
	if = { limit = { owner = { is_megacorp = yes } }
		multiply_variable = { which = kiyo_trade_minerals value = 1.5 }
		multiply_variable = { which = kiyo_trade_energy value = 1.5 }
		multiply_variable = { which = kiyo_trade_food value = 1.5 }
		multiply_variable = { which = kiyo_trade_unity value = 1.5 }
		multiply_variable = { which = kiyo_trade_consumer_goods value = 1.5 }
		multiply_variable = { which = kiyo_trade_alloys value = 1.5 }
		multiply_variable = { which = kiyo_trade_physics_research value = 1.5 }
		multiply_variable = { which = kiyo_trade_society_research value = 1.5 }
		multiply_variable = { which = kiyo_trade_engineering_research value = 1.5 }
		multiply_variable = { which = kiyo_trade_trade_value value = 1.5 }
	}
	
	#Make it 5% of production
	multiply_variable = { which = kiyo_trade_minerals value = 0.05 }
	multiply_variable = { which = kiyo_trade_energy value = 0.05 }
	multiply_variable = { which = kiyo_trade_food value = 0.05 }
	multiply_variable = { which = kiyo_trade_unity value = 0.05 }
	multiply_variable = { which = kiyo_trade_consumer_goods value = 0.05 }
	multiply_variable = { which = kiyo_trade_alloys value = 0.05 }
	multiply_variable = { which = kiyo_trade_physics_research value = 0.05 }
	multiply_variable = { which = kiyo_trade_society_research value = 0.05 }
	multiply_variable = { which = kiyo_trade_engineering_research value = 0.05 }
	multiply_variable = { which = kiyo_trade_trade_value value = 0.05 }
	
	orbit = {
		if = { limit = { NOT = { has_deposit = d_kiyo_mod_trade } } add_deposit = d_kiyo_mod_trade }
	}
	
	#Expand the fleet if allowed
	if = {
		limit = {
			check_variable = { which = kiyo_trade_max_cargo_ships_per_fleet value < Owner.kiyo_trade_max_cargo_ships_per_fleet }
			owner = {
				OR = {
					has_country_flag = auto_expand_cargo_fleets
					is_ai = yes
				}
				can_afford_trade_cargo_expansion = yes
			}
		}
		owner = { pay_trade_cargo_expansion = yes }
		roci_expand_trade_fleet = yes
	}
}

# Set timed fleet flag for how long a trade route should last
# THIS = FLEET
kiyo_mod_trade_set_route_time = {
	remove_fleet_flag = kiyo_event_trade_expired_cargo
	set_timed_fleet_flag = { flag = kiyo_event_trade_cargo_time days = 5400 }
}

# THIS = PLANET
kiyo_mod_trade_check_trade_route_exist = {
	if = { limit = { NOT = { any_country = { any_owned_fleet = { OR = { has_fleet_flag = kiyo_trade_start@PREVPREV has_fleet_flag = kiyo_trade_end@PREVPREV } } } } } remove_deposit = d_kiyo_mod_trade }
}

# THIS = COUNTRY
kiyo_mod_trade_set_num_trade_routes = {
	set_variable = { which = kiyo_trade_num_trade_routes value = 0 }
	every_owned_fleet = { limit = { any_owned_ship = { is_ship_size = kiyo_trade } NOT = { has_fleet_flag = kiyo_event_trade_deleted_cargo } }
		prev = { change_variable = { which = kiyo_trade_num_trade_routes value = 1 } }
	}
}

# THIS = FLEET
roci_expand_trade_fleet = {
	change_variable = { which = kiyo_trade_max_cargo_ships_per_fleet value = 1 }
	fleet_event = { id = kiyo_trade_manual_event.50 }
}